<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.69/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.69/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.5.0/css/bootstrap.css" rel="stylesheet">
  <script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.5.0/js/bootstrap.min.js"></script>
  <style>
    #pills-tabContent {
      width: 100%;
      height: 100%;
    }

    #view3D,
    #view2D {
      height: 600px;
    }

    .map-tool-bar {
      position: absolute;
      top: 1em;
      right: 1em;
    }
  </style>
</head>

<body>
  <!-- Tab panes -->
  <div class="tab-content" id="pills-tabContent">
    <div class="tab-pane fade show active" id="pills-home" role="tabpanel" aria-labelledby="pills-home-tab">
      <div id="view2D"></div>
      <div class="map-tool-bar">
        <div class="float-right mb-3">
          <button class="btn btn-sm bg-light" type="button" data-toggle="collapse" data-target="#collapseExample"
            data-placement="bottom" title="选择图层" aria-expanded="false" aria-controls="collapseExample">
            <img src="assets/layers.svg" width="24px" />
          </button>
          <button class="btn btn-sm bg-light" type="button" id="btn_home_2d" data-placement="bottom" title="回到原点">
            <img src="assets/home.svg" width="24px" />
          </button>
        </div>
        <div class="collapse" id="collapseExample" style="clear: both;">
          <div class="card card-body">
            <form class="form-inline">
              <label class="my-1 mr-2" for="inlineFormCustomSelectPref">图层选择</label>
              <select class="form-control form-control-sm" id="map2d_layer_selecter">
                <option value="1">矢量图层</option>
                <option value="2">影像图层</option>
              </select>
            </form>
          </div>
        </div>
      </div>
    </div>
    <div class="tab-pane fade" id="pills-profile" role="tabpanel" aria-labelledby="pills-profile-tab">
      <div id="view3D"></div>
      <div class="map-tool-bar">
        <div class="float-right mb-3">
          <button class="btn btn-sm bg-light" type="button" id="btn_home_3d" data-placement="bottom" title="回到原点">
            <img src="assets/home.svg" width="24px" />
          </button>
        </div>
      </div>
    </div>
  </div>
  <!-- Nav tabs -->
  <ul class="nav nav-pills nav-justified mb-3" id="pills-tab" role="tablist">
    <li class="nav-item" role="presentation">
      <a class="nav-link active" id="pills-home-tab" data-toggle="pill" href="#pills-home" role="tab"
        aria-controls="pills-home" aria-selected="true">
        二维地图</a>
    </li>
    <li class="nav-item" role="presentation">
      <a class="nav-link" id="pills-profile-tab" data-toggle="pill" href="#pills-profile" role="tab"
        aria-controls="pills-profile" aria-selected="false">
        三维地图</a>
    </li>
  </ul>
</body>
<script>

  $(function () {
    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJjMmFjNjdiNi1mMzZlLTRiOWItODRhNC0xNWI2NmIwODYyYmUiLCJpZCI6MjgxMjgsInNjb3BlcyI6WyJhc3IiLCJnYyJdLCJpYXQiOjE1OTA2NzYwNTh9.BxJOmxDjvTCxVbaUYidGPhEks8V8lhryYGwWlRKU0BA';
    // We want our two views to be synced across time, so we create
    // a shared clock object that both views share
    var clockViewModel = new Cesium.ClockViewModel();
    var options3D = {
      fullscreenElement: 'view3D',
      terrainProvider: Cesium.createWorldTerrain(),
      baseLayerPicker: false,
      sceneModePicker: false,
      animation: false,
      geocoder: false,
      sceneModePicker: false,
      selectionIndicator: false,
      timeline: false,
      navigationHelpButton: false,
      homeButton: false
    };
    var options2D = {
      sceneMode: Cesium.SceneMode.SCENE2D,
      fullscreenElement: 'view2D',
      baseLayerPicker: false,
      sceneModePicker: false,
      animation: false,
      geocoder: false,
      sceneModePicker: false,
      selectionIndicator: false,
      timeline: false,
      navigationHelpButton: false,
      homeButton: false
    };
    // We create two viewers, a 2D and a 3D one
    var view3D = new Cesium.Viewer("view3D", options3D);
    var view2D = new Cesium.Viewer("view2D", options2D);

    var boundingSphere = new Cesium.BoundingSphere(Cesium.Cartesian3.fromDegrees(117.957471, 27.651282, 500), 5000);
    // Set custom initial position
    view2D.camera.flyToBoundingSphere(boundingSphere, { duration: 0 });
    view3D.camera.flyToBoundingSphere(boundingSphere, { duration: 0 });


    //添加谷歌卫星图到2d地图
    var gle_satellite_layer = view2D.imageryLayers.addImageryProvider(new Cesium.UrlTemplateImageryProvider({
      url: "http://www.google.cn/maps/vt?lyrs=s@800&x={x}&y={y}&z={z}",
    }));
    //添加天地图中文图注到3d地图
    var td_chinese_label_3d = view3D.imageryLayers.addImageryProvider(new Cesium.WebMapTileServiceImageryProvider({
      url: "http://t0.tianditu.com/cva_w/wmts?tk=1b9f8327df331a175d1247be9fa4b03f&service=wmts&request=GetTile&version=1.0.0&LAYER=cva&tileMatrixSet=w&TileMatrix={TileMatrix}&TileRow={TileRow}&TileCol={TileCol}&style=default.jpg",
      layer: "tdtAnnoLayer",
      style: "default",
      format: "image/jpeg",
      tileMatrixSetID: "GoogleMapsCompatible"
    }));
    //添加天地图矢量到2d地图
    var td_verctor_layer = view2D.imageryLayers.addImageryProvider(new Cesium.WebMapTileServiceImageryProvider({
      url: "http://t0.tianditu.com/vec_w/wmts?tk=1b9f8327df331a175d1247be9fa4b03f&service=wmts&request=GetTile&version=1.0.0&LAYER=vec&tileMatrixSet=w&TileMatrix={TileMatrix}&TileRow={TileRow}&TileCol={TileCol}&style=default&format=tiles",
      layer: "tdtVecBasicLayer",
      style: "default",
      format: "image/jpeg",
      tileMatrixSetID: "GoogleMapsCompatible",
      show: false
    }));
    //添加天地图中文图注到2d地图
    var td_chinese_label_2d = view2D.imageryLayers.addImageryProvider(new Cesium.WebMapTileServiceImageryProvider({
      url: "http://t0.tianditu.com/cva_w/wmts?tk=1b9f8327df331a175d1247be9fa4b03f&service=wmts&request=GetTile&version=1.0.0&LAYER=cva&tileMatrixSet=w&TileMatrix={TileMatrix}&TileRow={TileRow}&TileCol={TileCol}&style=default.jpg",
      layer: "tdtAnnoLayer",
      style: "default",
      format: "image/jpeg",
      tileMatrixSetID: "GoogleMapsCompatible"
    }));
    //2d地图切换图层
    $('#map2d_layer_selecter').change(function () {
      //直接切换两个图层的显隐
      td_verctor_layer.show = !td_verctor_layer.show;
      gle_satellite_layer.show = !gle_satellite_layer.show;
      console.log(view2D.imageryLayers);
    });
    //二维地图回到原点按钮处理
    $('#btn_home_2d').click(function () {
      view2D.camera.flyToBoundingSphere(boundingSphere, { duration: 5 });
    });
    //三维地图回到原点按钮处理
    $('#btn_home_3d').click(function () {
      view3D.camera.flyToBoundingSphere(boundingSphere, { duration: 5 });
    });
    //多路线经纬度数组
    var majorRoutes = [
      {
        label: '路线一',
        labelPosition: {
          lng: 117.94133978757948,
          lat: 27.647918656108324
        },
        themeColor: '#3498db',
        points: [
          117.94448993613686, 27.653413334209205,
          117.94419333929802, 27.65284838743899,
          117.94396735972789, 27.65226931708033,
          117.94344478439646, 27.651873854179545,
          117.94272447694117, 27.6514077726631,
          117.94186293387085, 27.65091344423916,
          117.9414392237932, 27.650475610977136,
          117.94112850242304, 27.650122518976357,
          117.94105788407674, 27.649416335513582,
          117.94114205599438, 27.64882257115619,
          117.94125504524067, 27.648328242732262,
          117.94133978757948, 27.647918656108324,
          117.9416222609646, 27.6475796878307,
          117.94220133118853, 27.647396080238128,
          117.94290751465131, 27.64760793527696,
          117.94352895631407, 27.647989274454602,
          117.94415688318216, 27.64795454072547,
          117.94491956153745, 27.64765794280906,
          117.94552687974645, 27.6471353680164,
          117.94617656831669, 27.646711657938734,
          117.94723584351084, 27.646513925814872,
          117.94822352141837, 27.646712634166473,
          117.94840712954966, 27.64723521003669,
          117.94867547948103, 27.64818149544578,
        ]
      },
      {
        label: '路线二',
        labelPosition: {
          lng: 117.95691897837101,
          lat: 27.6558807548145
        },
        themeColor: '#27ae60',
        points: [
          117.95669525225435, 27.656879562817,
          117.95676289041495, 27.65667144527763,
          117.9567837020498, 27.65649454528979,
          117.95688255796038, 27.656312442442847,
          117.95690857265282, 27.656114730820143,
          117.95691897837101, 27.6558807548145,
          117.95696580489674, 27.65572466665998,
          117.95692909615619, 27.65551626138609,
          117.9567261814759, 27.655537073020938,
          117.9565700933214, 27.655495449155815,
          117.95657009332139, 27.65533415834067,
        ]
      }

    ];
    var pinBuilder = new Cesium.PinBuilder();
    for (let route of majorRoutes) {
      let line = view2D.entities.add({
        name: route.label,
        polyline: {
          positions: Cesium.Cartesian3.fromDegreesArray(route.points),
          width: 6,
          material: new Cesium.PolylineDashMaterialProperty({
            color: Cesium.Color.fromCssColorString(route.themeColor),
            gapColor: Cesium.Color.fromCssColorString('#e67e22')
          })
        },
        description: '\
        <div class="card" style="width: 18rem;">\
  <img src="..." class="card-img-top" alt="...">\
  <div class="card-body">\
    <h5 class="card-title">Card title</h5>\
    <p class="card-text">Some quick example text to build on the card title and make up the bulk of the card\'s content.</p>\
    <a href="#" class="btn btn-primary">Go somewhere</a>\
  </div>\
</div>',
        position: Cesium.Cartesian3.fromDegrees(route.labelPosition.lng, route.labelPosition.lat),
        billboard: {
          image: pinBuilder.fromText(route.label, Cesium.Color.fromCssColorString(route.themeColor), 96).toDataURL(),
          verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
        }
      });
    }

    //getPosition(view2D);
  });
  function getPosition(viewer) {
    //得到当前三维场景
    var scene = viewer.scene;
    //得到当前三维场景的椭球体
    var ellipsoid = scene.globe.ellipsoid;
    var entity = viewer.entities.add({
      label: {
        show: false
      }
    });
    var longitudeString = null;
    var latitudeString = null;
    var height = null;
    var cartesian = null;
    // 定义当前场景的画布元素的事件处理
    var handler = new Cesium.ScreenSpaceEventHandler(scene.canvas);
    //设置鼠标移动事件的处理函数，这里负责监听x,y坐标值变化
    handler.setInputAction(function (movement) {
      //通过指定的椭球或者地图对应的坐标系，将鼠标的二维坐标转换为对应椭球体三维坐标
      cartesian = viewer.camera.pickEllipsoid(movement.position, ellipsoid);
      if (cartesian) {
        //将笛卡尔坐标转换为地理坐标
        var cartographic = ellipsoid.cartesianToCartographic(cartesian);
        //将弧度转为度的十进制度表示
        longitudeString = Cesium.Math.toDegrees(cartographic.longitude);
        latitudeString = Cesium.Math.toDegrees(cartographic.latitude);
        //获取相机高度
        height = Math.ceil(viewer.camera.positionCartographic.height);
        entity.position = cartesian;
        entity.label.show = true;
        entity.label.text = '(' + longitudeString + ', ' + latitudeString + "," + height + ')';
        console.log(longitudeString + ',' + latitudeString + ',');
      } else {
        entity.label.show = false;
      }
    }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
    //设置鼠标滚动事件的处理函数，这里负责监听高度值变化
    handler.setInputAction(function (wheelment) {
      height = Math.ceil(viewer.camera.positionCartographic.height);
      entity.position = cartesian;
      entity.label.show = true;
      entity.label.text = '(' + longitudeString + ', ' + latitudeString + "," + height + ')';
    }, Cesium.ScreenSpaceEventType.WHEEL);
  }
</script>

</html>